# 티켓팅 서비스 — PRD (Product Requirements Document)

> **작성일**: 2026-02-04
> **현재 Phase**: Phase 1 (MVP)

---

## 1. 문제 정의 (Problem Statement)

### 배경

야구 인기 경기의 좌석 예매가 오픈되면 수천 명의 사용자가 동시에 접속한다. 이 과정에서 반복적으로 발생하는 문제가 있다.

### 구체적 Pain Point

**1. 좌석 선점 실패의 반복**

사용자가 좌석을 선택하고 "예매" 버튼을 누르는 사이에 다른 사용자가 해당 좌석을 먼저 선점한다. "이미 선점된 좌석입니다" 메시지를 마주한 사용자는 다시 빈 좌석을 찾아야 하고, 이 과정이 여러 번 반복되면서 예매 자체를 포기하게 된다.

**2. 좌석 현황의 정보 지연**

좌석 선택 화면이 실시간으로 갱신되지 않으면, 사용자는 이미 선점된 좌석을 "빈 좌석"으로 착각하고 선택한다. 선택 후 실패를 확인하기까지의 시간이 사용자 불만의 핵심이다.

**3. 유령 좌석 (Ghost Hold)**

선점 후 결제하지 않고 이탈한 사용자의 좌석이 계속 "선점됨"으로 표시된다. 다른 사용자는 해당 좌석을 선택할 수 없어 실질적으로 가용 좌석이 줄어든다.

### 핵심 목표

**좌석 선점 실패 경험을 최소화**하는 시스템을 설계한다.

이를 위해 세 가지 접근을 취한다:
1. **동시성 제어**: 같은 좌석에 대한 동시 요청을 안전하게 처리하여, 정확히 1명만 선점에 성공하도록 보장
2. **실시간 상태 공유**: 좌석 상태 변경을 1초 이내에 모든 사용자에게 전파하여, 이미 선점된 좌석을 선택하는 헛수고를 줄임
3. **만료 좌석 즉시 회수**: 선점 후 미결제 좌석을 자동으로 해제하여 가용 좌석을 최대화

---

## 2. 목표 및 성공 지표 (Goals & Success Metrics)

### 제품 목표

| 목표 | 설명 |
|------|------|
| E2E 사용자 여정 완결 | 회원가입부터 티켓 확인까지 끊김 없는 흐름 |
| 동시성 안전성 | 같은 좌석에 대한 동시 요청에서 데이터 정합성 보장 |
| 실시간 좌석 현황 | 좌석 상태 변경의 즉시 전파 |
| 만료 좌석 자동 회수 | 미결제 선점 좌석의 능동적 해제 |

### 성공 지표

| 지표 | 목표치 | 측정 방법 |
|------|--------|----------|
| 좌석 선점 동시성 안전성 | 같은 좌석 N명 동시 요청 시 정확히 1명만 성공 | 동시성 테스트 (2명/10명) |
| 좌석 상태 전파 지연 | 1초 이내 | SSE 이벤트 발행 주기 |
| API 처리량 (TPS) | > 500 (VU 1,000 기준) | K6 부하 테스트 |
| API p95 응답 시간 | < 1,000ms (VU 1,000 기준) | K6 부하 테스트 |
| API 에러율 | < 1% | K6 부하 테스트 |
| 만료 좌석 회수 지연 | TTL 만료 후 수 초 이내 | 스케줄러 주기 |

---

## 3. 대상 사용자

### 일반 사용자 (예매자)
야구 경기 좌석을 온라인으로 예매하는 사용자. 실시간 좌석 현황을 확인하고, 원하는 좌석을 선점하여 예약 및 결제를 진행한다.

### 관리자
경기를 생성하고 관리하는 운영자. 경기 정보를 등록하고, 예매 오픈 시점을 결정한다.

---

## 4. 사용자 스토리 및 핵심 시나리오

### 시나리오 1: 인기 경기 좌석 예매 (핵심 시나리오)

> 사용자 A는 이번 주말 LG 대 삼성 경기의 1루 내야석을 예매하려 한다. 경기 목록에서 해당 경기를 선택하면 좌석 선택 화면으로 진입한다. 구역(내야)과 섹션(홈)을 선택하면 해당 블록의 좌석 배치도가 나타난다.
>
> 좌석 배치도에서는 다른 사용자가 선점하는 좌석이 실시간으로 회색으로 바뀌는 것이 보인다. A는 빈 좌석 중 원하는 좌석을 터치하면 즉시 "선점됨(내 좌석)" 상태로 바뀐다. 이 시점에서 10분의 선점 유효 시간이 시작된다.
>
> 좌석 선택을 마친 A가 "예약하기"를 누르면 예약이 생성되고, 결제 화면으로 이동한다. 결제를 완료하면 예약이 확정되고, 티켓 화면에서 확정된 좌석 정보를 확인할 수 있다.

### 시나리오 2: 동시 선점 충돌

> 사용자 A와 B가 같은 좌석을 거의 동시에 선택한다. 시스템은 행 수준 잠금을 통해 정확히 1명만 선점에 성공시킨다. 실패한 사용자에게는 즉시 실패 피드백이 전달되고, 해당 좌석은 실시간으로 "선점됨" 상태로 갱신되어 다른 사용자에게도 보인다.

### 시나리오 3: 선점 후 미결제 이탈

> 사용자 C가 좌석을 선점한 후 결제하지 않고 브라우저를 닫는다. 10분 후 선점 유효 시간이 만료되면 시스템이 자동으로 해당 좌석을 해제한다. 해제된 좌석은 SSE를 통해 다른 사용자들에게 즉시 "사용 가능" 상태로 전파된다.

### 시나리오 4: 관리자 경기 오픈

> 관리자가 다음 주 경기를 DRAFT 상태로 등록한다. 경기 정보(구장, 홈/원정팀, 일시)를 입력하고 저장하면 DRAFT 상태로 생성된다. 예매 오픈 시점에 "오픈" 버튼을 누르면 해당 경기의 전체 좌석에 대한 배정(Allocation) 레코드가 일괄 생성되고, 사용자들이 좌석을 선택할 수 있게 된다.

---

## 5. 기능 요구사항 (Functional Requirements)

### 5.1 경기 관리 (Match) `P0`

| ID | 요구사항 | 설명 |
|----|----------|------|
| M-1 | 경기 생성 | 관리자가 구장, 홈/원정팀, 일시를 입력하여 DRAFT 상태로 경기를 생성할 수 있다 |
| M-2 | 경기 수정 | 관리자가 DRAFT 상태 경기의 정보를 수정할 수 있다 |
| M-3 | 경기 삭제 | 관리자가 경기를 삭제할 수 있다 |
| M-4 | 경기 오픈 | 관리자가 DRAFT→OPEN으로 전환할 수 있다. 전환 시 전체 좌석에 대한 Allocation 레코드가 일괄 생성된다 |
| M-5 | 경기 목록 조회 | 사용자가 OPEN 상태 경기 목록을 조회할 수 있다 |
| M-6 | 경기 단건 조회 | 사용자가 경기 상세 정보를 조회할 수 있다 |

### 5.2 좌석 구조 (Site Hierarchy) `P0`

| ID | 요구사항 | 설명 |
|----|----------|------|
| S-1 | 4단계 계층 조회 | Area→Section→Block→Seat 순서의 캐스케이딩 조회를 지원한다 |
| S-2 | 좌석 배치 시각화 | 행/열 기반 좌석 배치도를 반응형으로 렌더링한다 |

### 5.3 좌석 배정 (Allocation) `P0` — 핵심

| ID | 요구사항 | 설명 |
|----|----------|------|
| A-1 | 좌석 선점 | 사용자가 빈 좌석을 선택하면 AVAILABLE→HOLD로 전환된다. 선점에는 TTL(10분)이 적용된다 |
| A-2 | 좌석 해제 | 사용자가 본인이 선점한 좌석을 해제하면 HOLD→AVAILABLE로 전환된다 |
| A-3 | 좌석 확정 | 결제가 완료되면 HOLD→OCCUPIED로 전환된다 |
| A-4 | 동시성 제어 | 같은 좌석에 N명이 동시 요청하면 정확히 1명만 선점에 성공해야 한다 |
| A-5 | 실시간 좌석 현황 | SSE를 통해 좌석 상태 변경이 1초 이내에 모든 연결된 사용자에게 전파된다 |
| A-6 | 만료 좌석 자동 회수 | TTL이 만료된 HOLD 좌석을 능동적으로 AVAILABLE로 복원하고 SSE로 전파한다 |

### 5.4 예약 (Reservation) `P0`

| ID | 요구사항 | 설명 |
|----|----------|------|
| R-1 | 예약 생성 | 사용자가 HOLD 상태의 좌석들을 기반으로 PENDING 상태 예약을 생성할 수 있다 |
| R-2 | 예약 목록 조회 | 사용자가 본인의 예약 목록을 조회할 수 있다 |
| R-3 | 예약 단건 조회 | 사용자가 예약 상세 정보(좌석 포함)를 조회할 수 있다 |
| R-4 | 예약 취소 | 사용자가 예약을 취소하면 좌석이 AVAILABLE로 복원된다 | `P2`

### 5.5 결제 (Payment) `P0`

| ID | 요구사항 | 설명 |
|----|----------|------|
| P-1 | 결제 요청 | 예약 상태 검증 후 PENDING 상태 Payment를 생성한다 |
| P-2 | 결제 확인 및 확정 | 결제 완료 시 Payment→PAID, Reservation→CONFIRMED, Allocation→OCCUPIED로 일괄 전환한다 |
| P-3 | PG 연동 | 결제 게이트웨이를 통한 결제 처리. MVP에서는 Mock 어댑터로 대체한다 |
| P-4 | 환불 | 결제 취소 및 환불 처리 | `P2`

### 5.6 사용자 (User) `P0`

| ID | 요구사항 | 설명 |
|----|----------|------|
| U-1 | 회원가입 | 이메일 중복 검증 후 계정을 생성한다 |
| U-2 | 로그인 | 이메일/비밀번호로 인증한다 |
| U-3 | 인증/인가 | 토큰 기반 인증으로 API 요청의 사용자를 식별한다 | `P1`
| U-4 | 비밀번호 보안 | 비밀번호를 해시하여 저장한다 | `P2`

### 5.7 프론트엔드 `P0`

| ID | 요구사항 | 설명 |
|----|----------|------|
| F-1 | 모바일 퍼스트 레이아웃 | 480px 기준 반응형 레이아웃을 제공한다 |
| F-2 | 좌석 선택 UI | 실시간 좌석 배치도와 상태 표시, 낙관적 업데이트로 즉각적 피드백을 제공한다 |
| F-3 | 결제 화면 | 예약 정보 확인 및 결제 진행/결과 화면을 제공한다 |
| F-4 | 티켓 화면 | 결제 완료된 예약의 티켓 정보를 조회할 수 있다 |
| F-5 | 관리자 기능 | 관리자 역할의 사용자에게 경기 CRUD 기능을 제공한다 |

---

## 6. 비기능 요구사항 (Non-Functional Requirements)

### 동시성
같은 좌석에 N명이 동시 접근할 때 정확히 1명만 선점에 성공해야 하며, 데이터 정합성이 보장되어야 한다.

### 성능 (VU 1,000 기준)

| 항목 | 목표 |
|------|------|
| 처리량 (TPS) | > 500 |
| p95 응답 시간 | < 1,000ms |
| p99 응답 시간 | < 3,000ms |
| 에러율 | < 1% |

### 실시간성
좌석 상태 변경이 SSE를 통해 1초 이내에 연결된 모든 클라이언트에 전파되어야 한다.

### 아키텍처
- 헥사고날 아키텍처(Ports & Adapters)를 적용하여 도메인 로직을 인프라로부터 분리한다
- 도메인별 독립 패키지를 유지한다

---

## 7. 도메인 모델 개요

### 엔티티 관계

```
Match (경기)
  └─ Allocation (좌석 배정) ─── Seat (좌석)
       │                          └─ Block ─ Section ─ Area
       └─ Reservation (예약)
              └─ Payment (결제)

User (사용자) ──→ Allocation, Reservation
```

### 상태 전이

```
Match:       DRAFT ──→ OPEN

Allocation:  AVAILABLE ←─→ HOLD ──→ OCCUPIED
               (선점)    (해제)   (결제 완료)

Reservation: PENDING ──→ CONFIRMED
                    ──→ CANCELLED

Payment:     PENDING ──→ PAID
                    ──→ FAILED
```

### 핵심 비즈니스 규칙

- 하나의 경기에서 하나의 좌석은 하나의 Allocation만 존재한다 (Unique: matchId + seatId)
- 좌석 선점(HOLD)에는 10분의 TTL이 적용된다
- 예약은 HOLD 상태의 좌석에 대해서만 생성 가능하다
- 결제 확정 시 Payment→PAID, Reservation→CONFIRMED, Allocation→OCCUPIED가 원자적으로 전환된다

---

## 8. MVP 범위 및 릴리스 기준

### In-scope

| 기능 | 근거 |
|------|------|
| 회원가입/로그인 | 사용자 여정의 시작점 |
| 경기 관리 (관리자 CRUD + 오픈) | 데모 시나리오의 기본 콘텐츠 |
| SSE 실시간 좌석 현황 | 핵심 목표 — 선점 실패 최소화 |
| 좌석 선점/해제 (동시성 제어) | 핵심 목표 — 동시 요청 안전 처리 |
| 만료 좌석 능동적 회수 | 핵심 목표 — 가용 좌석 최대화 |
| 예약 생성 → 결제(Mock) → 티켓 확인 | E2E 사용자 여정 완결 |

### Out-of-scope

| 기능 | 제외 근거 |
|------|----------|
| PG 실연동 | Mock 어댑터로 결제 흐름 검증 가능. 헥사고날 Adapter 교체로 전환 가능 |
| 예약 취소/환불 | 정방향 흐름(예약→결제→확정) 안정화 우선 |
| JWT 인증/인가 | 핵심 목표(동시성, 실시간, 성능)에 집중. P1에서 구현 |
| 비밀번호 해싱 | 데모 환경에서 보안 위험 없음. P2에서 적용 |
| 알림 시스템 | 부가 기능 |
| 대기열 시스템 | Phase 3 범위 |
| 시즌권/멤버십, 포인트/쿠폰 | Phase 3 범위 |

### 릴리스 기준 (Definition of Done)

MVP가 "완성"이라고 할 수 있는 조건:

1. **E2E 흐름 동작**: 회원가입 → 로그인 → 경기 선택 → 좌석 선점 → 예약 → 결제(Mock) → 티켓 확인까지 끊김 없이 동작
2. **동시성 테스트 통과**: 같은 좌석 10명 동시 선점 시 정확히 1명만 성공
3. **부하 테스트 통과**: VU 1,000 기준 TPS > 500, 에러율 < 1%
4. **만료 회수 동작**: HOLD TTL 만료 후 자동 해제 및 SSE 전파 확인
5. **BDD 시나리오 전체 통과**: 모든 Cucumber Feature 시나리오 Green

---

## 9. 의존성 및 가정 (Dependencies & Assumptions)

### 가정

| 가정 | 근거 |
|------|------|
| PG 결제는 Mock으로 대체 가능하다 | 도메인 오케스트레이션(결제→예약 확정→좌석 확정) 검증이 목적. 실 PG는 Adapter 교체로 전환 가능 |
| 인증 없이 userId 파라미터 전달로 사용자를 식별한다 | MVP에서는 동시성/실시간/성능이 핵심. 인증은 P1에서 추가 |
| 좌석/구장 데이터는 사전 시딩(seeding)된다 | 좌석 구조(Area→Section→Block→Seat)는 관리 기능 없이 초기 데이터로 제공 |
| 단일 경기장을 가정한다 | MVP에서 다중 경기장 지원은 불필요 |

### 의존성

| 항목 | 설명 |
|------|------|
| PostgreSQL | 데이터 저장 및 행 수준 잠금 기반 동시성 제어 |
| Redis | 캐시 및 요청 병합(collapsing) |
| 초기 좌석 데이터 | 좌석 구조 시딩 SQL 또는 마이그레이션 |

---

## 10. 기술 스택

| 영역 | 기술 |
|------|------|
| Backend | Spring Boot 3.5 (Java 17), Spring Data JPA, QueryDSL |
| Frontend | Next.js 16 (TypeScript), Tailwind CSS, Zustand, React Query |
| DB/Cache | PostgreSQL 17, Redis 7, Caffeine |
| 테스트 | Cucumber (BDD), JUnit 5, Testcontainers, K6 |
| 인프라 | Docker Compose, Nginx, Terraform, AWS CodeDeploy |
| 모니터링 | Prometheus, Grafana |
| CI/CD | GitHub Actions |

---

## 부록: Feature Roadmap 요약

| Phase | 목표 | 주요 기능 |
|-------|------|----------|
| **Phase 1 (현재)** | MVP 완성 | E2E 사용자 여정, 만료 회수, 선점 타이머 UI |
| Phase 2 | 완성도 확보 | JWT 인증, 가격 체계, QR 티켓, 알림 |
| Phase 3 | 확장 기능 | 대기열 시스템, 포인트/쿠폰, 관리자 대시보드 |

상세: [`feature-roadmap.md`](./feature-roadmap.md)
